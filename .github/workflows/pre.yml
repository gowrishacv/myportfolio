name: Pre-production (build + test)

on:
    push:
        branches: [pre]
    workflow_dispatch:

permissions:
    contents: read

concurrency:
    group: pre-ci
    cancel-in-progress: true

jobs:
    build-test:
        name: Build + lint + test (pre)
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: 1.3.8

            - name: Install dependencies
              run: bun install --frozen-lockfile || bun install

            - name: Lint
              run: bun run lint

            - name: Test
              run: bun run test

            - name: Build
              # Build output for review. (This does NOT deploy anywhere.)
              # Use repo base so the build can be tested locally with a similar path.
              run: bun run build -- --base=/${{ github.event.repository.name }}/

            - name: Upload build artifact
              uses: actions/upload-artifact@v4
              with:
                  name: pre-dist
                  path: dist
                  retention-days: 7
